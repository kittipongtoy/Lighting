@{
    ViewData["Title"] = "Manage_Product_Page";
    Layout = "~/Views/Shared/Layout/_Layout.cshtml";
}
@using Lighting.Areas.Identity.Data
@model Lighting.Models.InputFilterModels.Product.Output_ProductVM

<style>
    .add-product-container {
        width: 100%;
        height: auto;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .add-product {
        width: 80%;
        height: auto;
        display: grid;
        grid-template-rows: 30vw auto auto auto auto auto auto auto auto auto auto auto;
        gap: 2rem;
    }

    .add-product-grid-item {
        display: grid;
        grid-template-rows: auto auto;
        & > input[type="text"]

    {
        height: 4rem;
    }

    }

    .add-spect-container {
        position: fixed;
        top: 0;
        left: auto;
        inset: 0;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(0,0,0,0.2);
    }

    .spect-grid-container {
        display: grid;
        grid-auto-rows: auto;
    }

    .spect-grid-item {
        display: grid;
        grid-template-columns: auto auto 5rem;
        border-bottom: 1px solid black;
        & > div

    {
        max-width: 100%;
        word-wrap: break-word;
        font-size: 1.7rem;
    }

    }

    .add-spect-box {
        width: 80%;
        min-width: 20vh;
        height: auto;
        border-radius: 10px;
        padding: 1rem;
        display: grid;
        grid-template-rows: 2rem auto 3rem 3rem auto 3rem;
        gap: 2rem;
        background-color: white;
        & > input[type="text"]

    {
        font-size: 2rem;
    }

    & > h3 {
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
    }

    }

    .add-product-grid-spec {
        height: auto;
        width: 100%;
        display: grid;
        grid-template-rows: 2rem auto auto auto auto;
        gap: 2rem;
        background-color: rgba(0,0,0,0.2);
        padding: 2rem;
        border-radius: 10px;
        & > h2

    {
        margin: -2rem;
        background-color: gray;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        border-radius: 5px;
    }

    }
</style>
<div style="display:flex;justify-content:space-between;margin:1rem 10%;">
    <div></div>
    <a href="@Url.Action("Manage_Product_Page","ManageProduct")" class="btn btn-primary">กลับ/back</a>
</div>
<div class="add-product-container">
    <div class="add-product">

        <div>
            <img src="@Model.Preview_Imamge" style="width:100%;height:100%;" id="img_preview" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">
                รูปสินค้า/Product Image
                <br />
                <span style="color:red;">
                    ขนาดรูปภาพ : 500 * 500 px
                </span>
            </label>
            <input class="form-control" type="file" id="file_img_preview" />
        </div>

        <div>
            <img src="@Model.Preview_Imamge_Show" style="width:100%;height:100%;" id="img_preview_Index" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">
                รูปสินค้าแสดงหน้า Home Index
                <br />
                <span style="color:red;">
                    ขนาดรูปภาพ : 500 * 500 px
                </span>
            </label>
            <input class="form-control" type="file" id="file_img_preview_Index" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">
                รูปสเปค/Spec Image
                <br />
                <span style="color:red;">
                    ขนาดรูปภาพ : 260 * 40 px
                </span>
                <a href="ManageProduct/DwonloadFile?path=@Model.SUB_IMG" target="_blank">download click  @Model?.SUB_IMG?.Split("\\").Reverse().Take(1).FirstOrDefault()</a>
            </label>
            <input class="form-control" type="file" id="sub_img_file" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">เลือกหมวดหมู่/category</label>
            <select class="form-control" id="product_category_id">
                @foreach (var cat in (IEnumerable<Product_Category>)ViewData["category"])
                {
                    if (Model.Product_CategoryId == cat.Id)
                    {
                        <option class="h5" value="@cat.Id" selected>@cat.Name_TH/@cat.Name_EN</option>
                    }
                    else
                    {
                        <option class="h5" value="@cat.Id">@cat.Name_TH/@cat.Name_EN</option>
                    }
                }
            </select>
        </div>

        <div class="add-product-grid-item">
            <label class="h4">เลือกชื่อรุ่น/model series</label>
            <select class="form-control" id="product_model_id">
                @foreach (var model_data in (IEnumerable<Product_Model>)ViewData["model"])
                {
                    if (Model.Product_ModelId == model_data.Id)
                    {
                        <option class="h5" value="@model_data.Id" selected>@model_data.Name_TH/@model_data.Name_EN</option>
                    }
                    @*else
                    {
                        <option class="h5" value="@model_data.Id">@model_data.Name_TH/@model_data.Name_EN</option>
                    }*@

                }
            </select>
        </div>

        <div class="add-product-grid-item">
            <label class="h4">ชื่อสินค้า/Product Name</label>
            <input type="text" placeholder="ชื่อรุ่น" value="@Model?.Model" id="model_name" />
        </div>

        <div>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" i>ประเภทสินค้า/Product Type</span>
                </div>
                <input type="text" class="form-control" id="category_name_th" placeholder="ภาษาไทย" value="@Model?.Type_TH">
                <input type="text" class="form-control" id="category_name_en" placeholder="English" value="@Model?.Type_EN">
            </div>
        </div>

        <div class="add-product-grid-item">
            <label class="h4">CUTSHEET <a href="ManageProduct/DwonloadFile?path=@Model?.CUTSHEET" target="_blank">download click @Model?.CUTSHEET?.Split("\\").Reverse().Take(1).FirstOrDefault()</a></label>
            <input class="form-control" type="file" id="cut_sheet_file" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">IES FILE  <a href="ManageProduct/DwonloadFile?path=@Model?.IESFILE" target="_blank">download click  @Model?.IESFILE?.Split("\\").Reverse().Take(1).FirstOrDefault()</a></label>
            <input class="form-control" type="file" id="ies_file" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">CATALOGUE  <a href="ManageProduct/DwonloadFile?path=@Model?.CATALOGUE" target="_blank">download click  @Model?.CATALOGUE?.Split("\\").Reverse().Take(1).FirstOrDefault()</a></label>
            <input class="form-control" type="file" id="catalogue_file" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">RFA FILE  <a href="ManageProduct/DwonloadFile?path=@Model?.RFA" target="_blank">download click  @Model?.RFA?.Split("\\").Reverse().Take(1).FirstOrDefault()</a></label>
            <input class="form-control" type="file" id="rfa_file" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">More Information</label>
            <input type="text" placeholder="https://MoreInformation.com" id="more_info" value="@Model?.MORE_INFORMATION" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">การใช้งาน/Application</label>
            <textarea id="application">@Model?.Application</textarea>
        </div>


        <div class="add-product-grid-item">
            <label class="h4">
                Photometric Data Image 
                @if (Model?.LIGHT_DISTRIBUTION != null)
                {
                    foreach (var img in Model.LIGHT_DISTRIBUTION)
                    {
                        <img src="@img" style="width:100px;height:100px;" />
                    }
                }
            </label>
            <br />
            <span style="color:red;">
                ขนาดรูปภาพ : 500 * 500 px (2รูปหากแก้ไขจะแทนที่รูปเก่าทันที)
            </span>
            <input class="form-control" type="file" multiple id="light_distribute_file" accept="image/*" />
        </div>

        <div class="add-product-grid-item">
            <label class="h4">
                Technical Drawing Image 
                @if (Model?.Technical_Drawing_Img != null)
                {
                    foreach (var img in Model.Technical_Drawing_Img)
                    {
                        <img src="@img" style="width:100px;height:100px;" />
                    }
                }
            </label>
            <br />
            <span style="color:red;">
                ขนาดรูปภาพ : 500 * 500 px (2รูปหากแก้ไขจะแทนที่รูปเก่าทันที)
            </span>
            <input class="form-control" type="file" multiple id="technical_img_file" accept="image/*" />
        </div>

        <div class="add-product-grid-spec">
            <h2>สเปค / Spacification</h2>

            <div class="add-product-grid-item">
                <label class="h4">IP Rating</label>
                <input type="text" placeholder="IP Rating" id="IP_Rating" value="@Model?.IP_Rating" />
            </div>

            <div class="add-product-grid-item">
                <label class="h4">Dimension</label>
                <input type="text" placeholder="Dimension" id="Dimension" value="@Model?.Dimension" />
            </div>

            <div class="add-product-grid-item">
                <label class="h4">Power</label>
                <input type="text" placeholder="Power" id="Power" value="@Model?.Power" />
            </div>         
            <div class="spect-grid-container">
                @if (Model?.Product_Spects != null)
                {
                    foreach (var spect in Model.Product_Spects)
                    {
                        <div class="spect-grid-item" id="@spect.Id">
                            <div>@spect.Name/</div>
                            <div>@spect.Value</div>
                            <button class="btn btn-danger" onclick="deleteSpectById(@spect.Id)"> ลบ </button>
                        </div>
                    }
                }
            </div>
            <div id="spect_container" class="spect-grid-container">
            </div>
            <center><button onclick="showHideSpect()" class="btn btn-success">เพิ่มสเปค/add space</button> </center>
        </div>


    </div>
    <br />
    <br />
    <centter style="margin-bottom:3rem;"><button onclick="editProduct(@Model?.Id)" class="btn btn-success">บันทึก/save</button></centter>
</div>

<div class="add-spect-container" style="display:none;" id="add_spect">
    <div class="add-spect-box">
        <h3>เพิ่มสเปค</h3>
        <div></div>
        <input type="text" placeholder="ชื่อสเปค" id="txt_spect_name" />
        <input type="text" placeholder="ค่าของสเปค" id="txt_spect_value" />
        <div></div>
        <div style="display:flex;justify-content:space-between">
            <button class="btn btn-success" onclick="addSpect()">เพิ่ม/add</button>
            <button class="btn btn-warning" onclick="showHideSpect()">ยกเลิก/cancle</button>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        var Application;
        ClassicEditor
            .create(document.querySelector('#application'))
            .then(editor => {
                console.log('Editor was initialized', editor);
                Application = editor;
            })
            .catch(error => {
                console.error(error);
            });
        var specification = [], spect_num = 0;
        var preview_img, sub_img_file, CutSheet_file, IesFile_file, Catalogue_file, rfa_file, technical_file, light_distribute_file;
        var preview_img_Index;
        $(document).ready(function () {
            
            appendSelectOptionOnLoad();
            categorySelectChange();

            $('#file_img_preview').change(async function (e) {
                if (e.target.files.length === 1) {
                    preview_img = e.target.files[0];
                    $('#img_preview').attr('src', await blobToBase64DataURL(preview_img)).css("display", "block");
                }
            });

            $('#file_img_preview_Index').change(async function (e) {
                if (e.target.files.length === 1) {
                    preview_img_Index = e.target.files[0];
                    $('#img_preview_Index').attr('src', await blobToBase64DataURL(preview_img_Index)).css("display", "block");
                }
            });

            $('#sub_img_file').change(function (e) {
                if (e.target.files.length === 1) {
                    sub_img_file = e.target.files[0];
                }
            });
            $('#cut_sheet_file').change(function (e) {
                if (e.target.files.length === 1) {
                    CutSheet_file = e.target.files[0];
                }
            });
            $('#ies_file').change(function (e) {
                if (e.target.files.length === 1) {
                    IesFile_file = e.target.files[0];
                }
            });
            $('#catalogue_file').change(function (e) {
                if (e.target.files.length === 1) {
                    Catalogue_file = e.target.files[0];
                }
            });
            $('#rfa_file').change(function (e) {
                if (e.target.files.length === 1) {
                    rfa_file = e.target.files[0];
                }
            });
            $('#technical_img_file').change(function (e) {
                if (e.target.files.length >= 1) {
                    technical_file = e.target.files;
                }
            });
            $('#light_distribute_file').change(function (e) {
                if (e.target.files.length >= 1) {
                    light_distribute_file = e.target.files;
                }
            });
        });

        function appendSelectOptionOnLoad(){
                fetch("/ManageProduct/SubcategoryJson?categoryId=@Model.Product_CategoryId").then(res => res.json()).then(json => {
                    //console.log(json);
                    var selectedId = @Model.Product_ModelId;
                var html_option = json.filter(x => x.id !== selectedId).reduce((prev, curr) => prev += `<option class="h5" value="${curr.id}">${curr.name_TH}/${curr.name_EN}</option>`, "");
                    $("#product_model_id").append(html_option);
                });
        }

        function categorySelectChange() {
            $('#product_category_id').on('change', function () {
                fetch("/ManageProduct/SubcategoryJson?categoryId=" + this.value).then(res => res.json()).then(json => {
                    //console.log(json);
                    var html_option = "<option class='h5' >กรุณาเลือก</option>";
                    html_option += json.reduce((prev, curr) => prev += `<option class="h5" value="${curr.id}">${curr.name_TH}/${curr.name_EN}</option>`, "");
                    $("#product_model_id").html(html_option);
                });
            });
        }

        function showHideSpect() {
            if ($("#add_spect").css("display") === "none") {
                $("#add_spect").css("display", "flex");
            } else {
                $("#add_spect").css("display", "none");
            }
        }

        function addSpect() {
            let name = $("#txt_spect_name").val();
            let value = $("#txt_spect_value").val();
            if (name !== "" && value !== "") {
                specification.push({ id: spect_num, name: name, value: value });
                let html_spect = specification.reduce((prev, curr) =>
                    prev += `<div class="spect-grid-item" id="spect${curr.id}">
                                                            <div> ${curr.name}</div>
                                                            <div> ${curr.value}</div>
                                                                    <button class= "btn btn-danger" onclick = "deleteSpect(${curr.id})" > ลบ </button>
                                                    </div>`, "");
                $("#spect_container").html(html_spect);
                spect_num++;
                showHideSpect();
                $("#txt_spect_name").val('');
                $("#txt_spect_value").val('');
            }
        }

        function deleteSpectById(id) {

            Swal.fire({
                icon: 'warning',
                title: "คุณแน่ใจว่าต้องการลบ?",
                text: "",
                showConfirmButton: true,
            }).then((confirm) => {
                if (confirm.isConfirmed) {

                    $.ajax({
                        type: 'POST',
                        url: '/ManageProduct/DeleteSpectById?id=' + id,
                        processData: false,
                        contentType: false,
                        cache: false,
                        beforeSend: function () {
                            Swal.fire('Please wait')
                            Swal.showLoading()
                        },
                        success: function (data) {
                            if (data.status == "success") {
                                Swal.fire({
                                    icon: 'success',
                                    title: data.message,
                                    showConfirmButton: false,
                                    timer: 2000
                                }).then(() => {
                                    $("#" + id).remove();//remove search
                                });
                            }
                            else {
                                Swal.fire({
                                    icon: 'warning',
                                    text: data.message,
                                });
                            }
                        }, error: function (e) {
                            Swal.fire({
                                icon: 'error',
                                text: e.message,
                            });
                            console.log(e.message);
                            console.log(e.inner);
                        }
                    });

                } else {

                }
            });
        }

        function deleteSpect(id) {
            specification = specification.filter(x => x.id != id);
            let html_spect = specification.reduce((prev, curr) =>
                prev += `<div class="spect-grid-item" id="spect${curr.id}">
                                                   <div> ${curr.name}</div>
                                                   <div> ${curr.value}</div>
                                                   <button class= "btn btn-danger" onclick = "deleteSpect(${curr.id})" > ลบ </button>
                                                 </div>`, "");

            $("#spect_container").html(html_spect);
        }

        function editProduct(id) {

            let form = new FormData();

            form.append("Product_CategoryId", $("#product_category_id").val());
            form.append("Product_ModelId", $("#product_model_id").val());
            form.append("Model", $("#model_name").val());
            form.append("Type_TH", $("#category_name_th").val());
            form.append("Type_EN", $("#category_name_en").val());
            form.append("Preview_Image", preview_img);
            form.append("Preview_Image2", preview_img_Index);
            form.append("SUB_IMG", sub_img_file);
            form.append("CUTSHEET", CutSheet_file);
            form.append("IESFILE", IesFile_file);
            form.append("CATALOGUE", Catalogue_file);
            form.append("RFA", rfa_file);
            form.append("MORE_INFORMATION", $("#more_info").val());
            form.append("Application", Application.getData()/*$("#application").val()*/);
            //form.append("Technical_Drawing", $("#").val());
            form.append("Power", $("#Power").val());
            form.append("Dimension", $("#Dimension").val());
            form.append("IP_Rating", $("#IP_Rating").val());
            if (specification.length > 0) {
                for (const spect of specification) {
                    form.append("Spect_Name", spect.name);
                    form.append("Spect_Value", spect.value);
                }
            }
            //form.append("Housing", $("#Housing").val());
            //form.append("Finishing", $("#Finishing").val());
            //form.append("Lens", $("#Lens").val());
            //form.append("Gasket", $("#Gasket").val());
            //form.append("Mounting", $("#Mounting").val());
            //form.append("Source", $("#Source").val());
            //form.append("Lamp_Colour", $("#Lamp_Colour").val());
            //form.append("Luminaire_Output", $("#Luminaire_Output").val());
            //form.append("Beam_Angle", $("#Beam_Angle").val());
            //form.append("Control_Gear", $("#Control_Gear").val());
            //form.append("Power_Supply", $("#Power_Supply").val());
            //form.append("Luminaire_Lifetime", $("#Luminaire_Lifetime").val());
            //form.append("Equivalent", $("#Equivalent").val());

            if (light_distribute_file != undefined) {
                for (const file of light_distribute_file) {
                    form.append("LIGHT_DISTRIBUTION", file);
                }
            }

            if (technical_file != undefined) {
                for (const file of technical_file) {
                    form.append("Technical_Drawing_Img", file);
                }
            }

            $.ajax({
                type: 'POST',
                url: '/ManageProduct/Edit_Product?id=' + id,
                data: form,
                processData: false,
                contentType: false,
                cache: false,
                beforeSend: function () {
                    Swal.fire('Please wait')
                    Swal.showLoading()
                },
                success: function (data) {
                    if (data.status == "success") {
                        Swal.fire({
                            icon: 'success',
                            title: data.message,
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => {
                            window.location.href = "/ManageProduct/Manage_Product_Page";
                        });
                    }
                    else {
                        Swal.fire({
                            icon: 'warning',
                            text: data.message,
                        });

                    }
                }, error: function (e) {
                    Swal.fire({
                        icon: 'error',
                        text: e.message,
                    });
                    console.log(e.message);
                    console.log(e.inner);
                }
            });
        }

        const blobToBase64DataURL = blob => new Promise(
            resolvePromise => {
                const reader = new FileReader();
                reader.onload = () => resolvePromise(reader.result);
                reader.readAsDataURL(blob);
            }
        );
    </script>
}