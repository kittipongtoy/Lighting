@using Lighting.Areas.Identity.Data;
@{
    ViewData["Title"] = "Manage_Product_Page";
    Layout = "~/Views/Shared/Layout/_Layout.cshtml";
}
@model IEnumerable<Lighting.Models.InputFilterModels.Product.Output_ProductModelVM>

<div class="container" style="width:100%;">

    <div class="row d-flex justify-content-between mb-3">
        <div class="col d-flex justify-content-between">
            <div>
                <button class="btn btn-primary" id="btn_add_category">เพิ่มโมเดล/add model</button>
            </div>
            <a href="@Url.Action("Manage_Product_Page","ManageProduct")" class="btn btn-primary rounded-2">
                กลับ/back
            </a>
        </div>
    </div>


    <div class="row mt-3" style="display:none;" id="add_category">
        <div class="col-12 text-center">
            <img style="width:100%;height:50vh;display:none;" id="img_preview" />
        </div>
        <div class="col-12 " style="margin-top:3rem;">
            <select class="form-select" id="category" style="margin-bottom:3rem;">
                <option selected>กรุณเลือกหมวดหมู่/Select Category</option>
                @foreach (Product_Category category in (IEnumerable<Product_Category>)ViewData["category"])
                {
                    <option value="@category.Id">@category.Name_TH/@category.Name_EN</option>
                }
            </select>
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="">ชื่อโมเดล/Model Name</span>
                </div>
                <input type="text" class="form-control" id="category_name_th" placeholder="ภาษาไทย">
                <input type="text" class="form-control" id="category_name_en" placeholder="English">
            </div>
            <label class="form-label mt-3">เลือกรูปโมเดล/Image Model</label>
            <input class="form-control mt-3" type="file" id="file_img_preview">
        </div>
        <center><button class="btn btn-success" style="margin-top:3rem;" onclick="addCategory()">บันทึก/save</button></center>
    </div>

    <div class="row mt-5">

        <table class="table mt-3">
            <thead>
                <tr style="border-top:1px solid black;border-bottom:1px solid black;">
                    <th scope="col">#</th>
                    <th scope="col">รูปปก/Image Preview</th>
                    <th scope="col">ชื่อโมเดล/Model Name</th>
                    <th scope="col" class="text-center">จัดการ/Manage</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int i = 1;
                }
                @foreach (var model_data in Model)
                {
                    <tr id="@model_data.Id">
                        <th scope="row">@i</th>
                        <td><img src="~/@model_data.Image" style="width:100px;height:100px;" /> </td>
                        <td>@model_data.Name_TH / @model_data.Name_EN</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-warning" onclick="edit(@model_data.Id,'@model_data.Image.Replace('\\','/')','@model_data.Name_TH','@model_data.Name_EN',@model_data.Product_CategoryId)">
                                <i class="bi bi-pencil-square"></i>แก้ไข/edit
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteRowById(@model_data.Id)">
                                <i class="bi bi-trash-fill"></i>ลบ/delete
                            </button>
                        </td>
                        @{
                            i++;
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div style="position:fixed;inset:0;background-color:rgba(0,0,0,0.5);display:none;justify-content:center;flex-direction:column;align-items:center;z-index:10" id="edit_page">
    <div style="width:50%;height:auto;padding:3rem;background-color:white;border-radius:10px">
        <div style="display:grid;grid-template-rows:auto 3rem 3rem 3rem;gap:2rem;">
            <div>
                <img id="edit_img_preview" style="width:100%;height:100%;" />
            </div>

            <select class="form-select" id="edit_category">
                <option selected>กรุณเลือกหมวดหมู่/Select Category</option>
                @foreach (Product_Category category in (IEnumerable<Product_Category>)ViewData["category"])
                {
                    <option value="@category.Id">@category.Name_TH/@category.Name_EN</option>
                }
            </select>

            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">ชื่อหมวดหมู่/Category Name</span>
                </div>
                <input type="text" class="form-control" id="edit_category_name_th" placeholder="ภาษาไทย">
                <input type="text" class="form-control" id="edit_category_name_en" placeholder="English">
            </div>

            <div>
                <input class="form-control mt-3" style="margin:0" type="file" id="edit_file_img_preview">
            </div>

            <center>
                <button class="btn btn-primary" style="margin:0 3rem;" onclick="saveEdit()">บันทึก/save</button>
                <button class="btn btn-primary btn-danger" style="margin: 0 3rem;" onclick="closeEdit()">ปิด/close</button>
            </center>
        </div>
    </div>
</div>

@section Scripts{
    <script>

        const blobToBase64DataURL = blob => new Promise(
            resolvePromise => {
                const reader = new FileReader();
                reader.onload = () => resolvePromise(reader.result);
                reader.readAsDataURL(blob);
            }
        );

        var edit_id;
        var add_img_file;
        var edit_img_file;

        $(document).ready(function () {

            $('#file_img_preview').change(async function (e) {
                if (e.target.files.length === 1) {
                    add_img_file = e.target.files[0];
                    $('#img_preview').attr('src', await blobToBase64DataURL(add_img_file)).css("display", "block");
                }
            });

            $('#edit_file_img_preview').change(async function (e) {
                if (e.target.files.length === 1) {
                    edit_img_file = e.target.files[0];
                    $('#edit_img_preview').attr('src', await blobToBase64DataURL(edit_img_file));
                }
            });

            $("#btn_add_category").on("click", function () {
                let display = $("#add_category").css("display");
                if (display == "none") {
                    $("#add_category").css("display", "flex");
                } else {
                    $("#add_category").css("display", "none");
                }
            });

        });

        function addCategory() {

            let category_name_th = $("#category_name_th").val();
            let category_name_en = $("#category_name_en").val();
            let form = new FormData();
            form.append("Name_TH", category_name_th);
            form.append("Name_EN", category_name_en);
            form.append("Product_CategoryId", $("#category").val());

            if (add_img_file != undefined) {
                form.append("Image", add_img_file);
            }

            //ajax
            $.ajax({
                type: 'POST',
                url: '/ManageProduct/Add_Model',
                data: form,
                processData: false,
                contentType: false,
                cache: false,
                beforeSend: function () {
                    Swal.fire('Please wait')
                    Swal.showLoading()
                },
                success: function (data) {
                    if (data.status == "success") {
                        Swal.fire({
                            icon: 'success',
                            title: data.message,
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => {
                            window.location.href = "/ManageProduct/Manage_Model_Page";
                        });
                    }
                    else {
                        Swal.fire({
                            icon: 'warning',
                            text: data.message,
                        });
                    }
                }, error: function (e) {
                    Swal.fire({
                        icon: 'error',
                        text: e.message,
                    });
                    console.log(e.message);
                    console.log(e.inner);
                }
            });
        }

        function closeEdit() {
            $("#edit_page").css("display", "none");
        }

        function saveEdit() {

            if (!edit_id) {
                Swal.fire({
                    icon: 'error',
                    text: "กรุณาเลือกค้าที่ต้องการแก้ไข",
                });
            }

            let category_name_th = $("#edit_category_name_th").val();
            let category_name_en = $("#edit_category_name_en").val();


            let form = new FormData();
            form.append("Name_TH", category_name_th);
            form.append("Name_EN", category_name_en);
            form.append("Product_CategoryId", $("#edit_category").val());

            if (edit_img_file != undefined) {
                form.append("Image", edit_img_file);
            }

            //ajax
            $.ajax({
                type: 'POST',
                url: '/ManageProduct/Edit_ModelById?id=' + edit_id,
                data: form,
                processData: false,
                contentType: false,
                cache: false,
                beforeSend: function () {
                    Swal.fire('Please wait')
                    Swal.showLoading()
                },
                success: function (data) {
                    if (data.status == "success") {
                        Swal.fire({
                            icon: 'success',
                            title: data.message,
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => {
                            //append file
                            edit_id = null;
                            window.location.href = "/ManageProduct/Manage_Model_Page";
                        });
                    }
                    else {
                        Swal.fire({
                            icon: 'warning',
                            text: data.message,
                        });
                    }
                }, error: function (e) {
                    Swal.fire({
                        icon: 'error',
                        text: e.message,
                    });
                    console.log(e.message);
                    console.log(e.inner);
                }
            });
        }

        function edit(id, img_path, name_th, name_en, category) {
            edit_id = id;
            $("#edit_page").css("display", "flex");
            $("#edit_category_name_th").val(name_th);
            $("#edit_category_name_en").val(name_en);
            $('#edit_img_preview').attr('src', img_path);
            $('#edit_category').val(category);
        }

        function deleteRowById(id) {

            Swal.fire({
                icon: 'warning',
                title: "คุณแน่ใจว่าต้องการลบ?",
                text: "",
                showConfirmButton: true,
            }).then((confirm) => {
                if (confirm.isConfirmed) {

                    $.ajax({
                        type: 'POST',
                        url: '/ManageProduct/Delete_ModelById?id=' + id,
                        processData: false,
                        contentType: false,
                        cache: false,
                        beforeSend: function () {
                            Swal.fire('Please wait')
                            Swal.showLoading()
                        },
                        success: function (data) {
                            if (data.status == "success") {
                                Swal.fire({
                                    icon: 'success',
                                    title: data.message,
                                    showConfirmButton: false,
                                    timer: 2000
                                }).then(() => {

                                    $("#" + id).remove();
                                });
                            }
                            else {
                                Swal.fire({
                                    icon: 'warning',
                                    text: data.message,
                                });
                            }
                        }, error: function (e) {
                            Swal.fire({
                                icon: 'error',
                                text: e.message,
                            });
                            console.log(e.message);
                            console.log(e.inner);
                        }
                    });

                } else {

                }
            });
        }

    </script>
}
